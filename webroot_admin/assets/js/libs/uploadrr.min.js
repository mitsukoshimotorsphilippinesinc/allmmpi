if(!Array.indexOf){Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++){if(this[b]==a){return b}}return-1}}(function(a){a.fn.Uploadrr=function(b){var c={simpleFile:false,maxFileSize:-1,progressGIF:"pr.gif",target:"upload.php",singleUpload:false,onComplete:function(){},onError:function(){}};if(b){a.extend(c,b)}var d={settings:c,current:0,totalSize:0,totalLoaded:0,fileCount:0,lastValue:"",files:{modern:false,items:[]},DragDropSupported:typeof window.File=="object"&&typeof window.FileReader=="function"&&typeof window.FileList=="object",enableDragDrop:function(){defaultFunc=function(a){a.stopPropagation();a.preventDefault()};this.fileListDiv[0].addEventListener("dragenter",defaultFunc,false);this.fileListDiv[0].addEventListener("dragover",defaultFunc,false);this.fileListDiv[0].addEventListener("drop",a.proxy(function(a){a.stopPropagation();a.preventDefault();this.addFile(a.dataTransfer)},this),false)},render:function(b){b.addClass("uploadBox_fu");fform=a("<form/>");this.realDiv=a("<div/>",{"class":"real"});this.fileField=a("<input/>",{"class":"file",name:"file",type:"file",size:"34"}).css({height:"35",margin:"0",width:"400"});if(this.settings.simpleFile==true)this.fileField.css({opacity:1});else{this.fakeDiv=a("<div/>",{"class":"fake"});this.ftext=a("<input/>",{type:"text","class":"text bev"}).css({display:"inline","margin-right":"5px"});this.fakeDiv.append(this.ftext);this.fakeDiv.append(a("<input/>",{type:"button","class":"button bev xx",value:"Browse"}).css({display:"inline",height:"35px",margin:"0","margin-bottom":"2px"}));this.realDiv.append(this.fakeDiv)}this.realDiv.append(this.fileField);fform.append(this.realDiv);fform.append(a("<br/>"));this.fileListDiv=a("<div/>",{"class":"fileList bev"});this.upInfoDiv=a("<div/>",{"class":"upInfo"}).hide();this.totalPro=a("<div/>",{"class":"totalPro"});this.filePro=a("<div/>",{"class":"filePro"});this.upInfoDiv.append(this.filePro);this.upInfoDiv.append(a("<img/>",{src:this.settings.progressGIF,id:"prImg"}));this.upInfoDiv.append(this.totalPro);this.fileListDiv.append(this.upInfoDiv);this.info=a("<div/>",{"class":"info"}).html('To select files click "BROWSE" '+(this.DragDropSupported?"or drag them into this box.":".")+(typeof this.settings.allowedExtensions=="object"?"<br>Allowed file types: "+this.settings.allowedExtensions.join(", "):""));this.fileListDiv.append(this.info);fform.append(this.fileListDiv);this.submit=a("<input/>",{type:"button",value:"Upload","class":a.browser.msie?"ib":"button bev"}).css({width:"auto",height:"35px",position:"relative",padding:"6px 20px"});fform.append(this.submit);b.append(fform);temp=function(a){var b=document.createElement("div");b.innerHTML=a;return b.firstChild};this.upFrame=temp('<iframe name="upFrame" src="about:blank" style="display:none"></iframe>');document.body.appendChild(this.upFrame);b.append(this.upFrame);if(this.DragDropSupported)a.proxy(this.enableDragDrop(),this);this.fileField.bind("change",a.proxy(this.addFile,this));this.submit.bind("click",a.proxy(this.sendFiles,this))},checkExt:function(a){fileExt=a.substr(a.indexOf("."),a.length).toLowerCase();if(typeof this.settings.allowedExtensions=="object"){if(this.settings.allowedExtensions.indexOf(fileExt)>-1)return true;else alert(a+" is not allowed.\r\nAllowed file types: "+this.settings.allowedExtensions.join(", "))}else return true},addFile:function(b){if(b.files)caller=b;else{caller=b.target;if(this.lastValue==b.target.value){return}}if(this.settings.singleUpload==true){this.files.items=[];a("div.fileItem").remove();this.current=0;this.fileCount=0;this.upInfoDiv.hide();this.upInfoDiv.removeClass("result");this.upInfoDiv.html("");this.upInfoDiv.css({"background-color":""});this.upInfoDiv.append(this.filePro);this.upInfoDiv.append(a("<img/>",{src:this.settings.progressGIF,id:"prImg"}));this.upInfoDiv.append(this.totalPro)}appendFile=function(b){fname=b.fileName?b.fileName:b.value;fname=fname.split("\\");fname=fname[fname.length-1];fileItem=a("<div/>",{"class":"fileItem bev"});delBtn=a("<div/>",{"class":"delete"}).html("<b>Delete</b>");fileItem.append(delBtn);fileItem.append(a("<div/>",{"class":"progress",style:"width:0%"}));fileItem.append(a("<i/>",{style:"position:relative;z-index:1;"}).html(fname));this.fileListDiv.append(fileItem);delBtn.bind("click",{fileItem:fileItem,file:b,fname:fname,_this:this},function(a){a.data.fileItem.remove();removeItem=a.data.file;a.data._this.files.items=jQuery.grep(a.data._this.files.items,function(a){return a!=removeItem});if(a.data._this.files.items.length==[])a.data._this.info.show();if(a.data._this.ftext)a.data._this.ftext.val(a.data.fname+" deleted.")})};if(caller.files&&(new XMLHttpRequest).upload!=null){this.files.modern=true;for(i=0;i<caller.files.length;i++){file=caller.files[i];file.fileName=file.name;file.fileSize=file.size;if(this.checkExt(file.fileName)){if(file.fileSize<this.settings.maxFileSize||this.settings.maxFileSize==-1){if(this.info.is(":visible")){this.info.hide()}this.files.items.push(file);a.proxy(appendFile,this)(file);l=this.files.items.length;ct=l==1?" file":" files";this.ftext.val(l+ct+" added.")}else alert("Maximum file size: "+this.settings.maxFileSize+" bytes.")}}}else{if(this.checkExt(caller.value)){if(this.info.is(":visible")){this.info.hide()}this.lastValue=caller.value;this.files.modern=false;this.files.items.push(caller);this.fileField=a("<input/>",{"class":"file",name:"file",type:"file",multiple:"true"}).bind("change",a.proxy(this.addFile,this)).css({opacity:1});a(caller).after(this.fileField);a(caller).hide();a.proxy(appendFile,this)(caller)}}},sendFiles:function(){if(this.files.items.length<1){this.ftext.val("No files selected.");return}a(".delete").each(function(b){a(this).hide()});disable=function(b){b=a(b);b.die();b.removeClass("button");b.addClass("disabled")};this.fileField.die();disable(this.submit);disable(!this.fakeDiv?this.fileItem:this.fakeDiv.children()[1]);if(!this.upInfoDiv.is(":visible")){this.upInfoDiv.slideDown("fast")}if(this.files.modern){this.tSize(false);a.proxy(this.uploadModern,this)(this.files.items[0])}else{a.proxy(this.tSize,this)(true);a.proxy(this.uploadStandart,this)(this.files.items[0]);a(this.upFrame).bind("load",a.proxy(function(){this.reply=this.upFrame.contentWindow.document.body.innerHTML;try{this.reply=a.parseJSON(this.reply)}catch(b){this.uploadError("jsonError")}if(this.reply.success){if(this.nform)this.nform.remove();a(this.fileListDiv.children(".fileItem")[this.current].children[1]).css({width:"100%"});fname=this.files.items[this.current].value.split("\\");fname=fname[fname.length-1];a(this.fileListDiv.children(".fileItem")[this.current].children[2]).html(a("<a/>",{href:this.reply.file}).html(fname));this.current++;if(this.files.items[this.current]){this.uploadStandart(this.files.items[this.current])}else{this.allDone();if(a.browser.msie){a(this.upFrame).unbind("load");this.nform=a("<form/>",{target:"upFrame",action:"about:blank"}).hide();this.fileListDiv.append(this.nform);this.nform.submit()}}}else this.uploadError("customError")},this))}},tSize:function(b){this.fileCount=this.files.items.length;if(b)return;a(this.files.items).each(a.proxy(function(a){this.totalSize=this.files.items[a].fileSize+this.totalSize},this));this.totalSize=(this.totalSize/1024).toFixed()},uploadProgress:function(b){percent=(b.loaded*100/b.total).toFixed();loaded=(b.loaded/1024).toFixed();total=(b.total/1024).toFixed();this.filePro.html("Current file: "+percent+"% "+loaded+"KB/"+total+"KB");this.totalPro.html("Total: "+(this.current+1)+"/"+this.fileCount+" files "+((this.totalLoaded+b.loaded)/1024).toFixed()+"/"+this.totalSize+"KB");a(this.fileListDiv.children(".fileItem")[this.current].children[1]).css({width:percent+"%"})},uploadFinished:function(b){percent=(b.loaded*100/b.total).toFixed();loaded=(b.loaded/1024).toFixed();total=(b.total/1024).toFixed();this.totalLoaded=this.totalLoaded+b.total;this.filePro.html("Current file: 100% "+total+"KB/"+total+"KB");this.totalPro.html("Total: "+(this.current+1)+"/"+this.fileCount+" files "+(this.totalLoaded/1024).toFixed()+"/"+this.totalSize+"KB");a(this.fileListDiv.children(".fileItem")[this.current].children[1]).css({width:"100%"})},allDone:function(){enable=function(b){b=a(b);b.die();b.addClass("button");b.removeClass("disabled")};this.upInfoDiv.html("<h2>Uploaded!</h2>").addClass("result").css({backgroundColor:"#CDEB8B"});var retItems=[];for(f in this.files.items){var tmpItem={'fileName':this.files.items[f].fileName,'fileSize':this.files.items[f].fileSize,'fileType':this.files.items[f].type};retItems.push(tmpItem);}this.settings.onComplete(retItems);enable(this.submit);enable(!this.fakeDiv?this.fileItem:this.fakeDiv.children()[1])},uploadError:function(b){this.upInfoDiv.html("<h2>Upload Failed</h2>").addClass("result").css({backgroundColor:"#B02B2C",color:"white"});a(this.fileListDiv.children(".fileItem")[this.current].children[1]).css({width:"100%",backgroundColor:"#B02B2C"});switch(b){case"statusError":response="<b> Bad Response: "+this.xhr.status+" "+this.xhr.statusText+" </b>";break;case"customError":response="<b> Server Error: "+this.reply.details+" </b>";break;case"jsonError":response="<b>Server returned invalid JSON response.</b>";break;case"fileMatchError":response="<b> The file sent and the file received on the server dont match. </b>";break;default:response="<b> Upload Failed.</b>";break}this.upInfoDiv.append(response);this.settings.onError(response)},uploadModern:function(b){if(b!==null){this.xhr=new XMLHttpRequest;this.xhr.upload.addEventListener("progress",a.proxy(this.uploadProgress,this),false);this.xhr.upload.addEventListener("load",a.proxy(this.uploadFinished,this),false);this.xhr.upload.addEventListener("error",a.proxy(this.uploadError,this),false);this.xhr.open("POST",this.settings.target);this.xhr.setRequestHeader("If-Modified-Since","Mon, 26 Jul 1997 05:00:00 GMT");this.xhr.setRequestHeader("Cache-Control","no-cache");this.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");this.xhr.setRequestHeader("X-File-Name",b.fileName);this.xhr.setRequestHeader("X-File-Size",b.fileSize);this.xhr.setRequestHeader("Content-Type","multipart/form-data");this.xhr.onreadystatechange=a.proxy(function(){if(this.xhr.readyState==4){if(this.xhr.status<400&&this.xhr.status>=200){try{this.reply=a.parseJSON(this.xhr.responseText)}catch(b){this.uploadError("jsonError")}if(this.reply.success){a(this.fileListDiv.children(".fileItem")[this.current].children[2]).html(a("<a/>",{href:this.reply.file}).html(this.reply.file));this.current++;if(this.files.items[this.current]){this.uploadModern(this.files.items[this.current])}else{this.allDone()}}else this.uploadError("customError")}else this.uploadError("statusError")}},this);if(b.getAsBinary!=undefined){this.xhr.sendAsBinary(b.getAsBinary(b))}else{this.xhr.send(b)}}},uploadStandart:function(b){this.filePro.html("Uploading : "+b.value);this.totalPro.html("File "+(this.current+1)+" of "+this.fileCount);this.nform=a("<form/>",{id:"upForm",method:"POST","accept-charset":"UTF-8",target:"upFrame",action:this.settings.target,enctype:"multipart/form-data",encoding:"multipart/form-data"}).hide();this.nform.append(b);this.fileListDiv.append(this.nform);this.nform.submit()}};d.render(this)}})(jQuery)